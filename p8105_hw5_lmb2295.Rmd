---
title: "Homework 5"
author: "Laya Buchanan"

date: 2020-11-05
output: github_document
---

This is my submission for the fifth homework assignment for P8105.  

```{r message = FALSE, echo = FALSE}
library(tidyverse)
library(broom)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 2: Longitudinal study data

First, I created a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time from the original folder of .csv files.

```{r}
control_exp_df = 
  map_df(list.files(path = "./data", full.names = TRUE), read.csv) %>% 
  mutate(file_name = list.files(path = "./data")) %>% 
  relocate(file_name, .before = week_1) %>% 
  separate(file_name, into = c("arm", "id"), sep = "_") %>% 
  separate(id, into = c("id", "delete"), sep = "\\.") %>% 
  select(-delete) %>% 
  mutate(arm = recode(arm, 'con' = "control")) %>% 
  mutate(arm = recode(arm, 'exp' = "experimental"))
  
```

Then, I made a spaghetti plot showing observations on each subject over time by week.

```{r}
control_exp_df %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "value"
    ) %>% 
  unite(group, arm:id, sep = '', remove = FALSE) %>% 
  ggplot(aes(x = week, y = value, group = group, color = arm)) + 
  geom_line() + 
  labs(
    title = "Measurement for Control vs Experimental Arm Over Time",
    x = "Week",
    y = "Value") +
   theme(legend.position = "right")
```

While measurements for the variable of interests were comparable at baseline for the control and experimental groups, values increased over time for the experimental group, but not for the control group. There was considerable inter- and intra-individual variability in both groups.

# Problem 3: Power

```{r}
sim_t_test = function(n = 30, mu, sigma = 5) {
  
  sim_data = tibble(
    x = rnorm(n, mean = mu, sd = sigma)
  )
  
    sim_data %>% 
      t.test(
      mu = 0,
      conf.level = 0.95) %>% 
      tidy()
  

}
```

```{r}
output = vector("list", length = 100)

for (i in 1:100) {
  
  output[[i]] = sim_t_test(mu = 0)
  
}

bind_rows(output)
```

```{r}
sim_results =
rerun(100, sim_t_test(mu = 0)) %>% 
  bind_rows()
```


```{r}
mu_list = 
  list(
    "mu = 0" = 0,
    "mu = 1" = 1,
    "mu = 2" = 2,
    "mu = 3" = 3,
    "mu = 4" = 4,
    "mu = 5" = 5,
    "mu = 6" = 6
  )

for (i in 1:7) {
  output[[i]] = 
    rerun(100, sim_t_test(mu = mu_list[[i]]))
bind_rows()
}


tibble(
  mu = c(0, 1, 2, 3, 4, 5, 6)
) %>% 
  mutate(
    output_lists = map(.x = mu, ~rerun(100, sim_t_test(mu = .x))), 
estimate_df = map(output_lists, bind_rows
  )
) %>% 
  unnest(estimate_df) %>% 
  select(mu, estimate, p.value)
```

